{% load static %}

<!DOCTYPE html>
<html lang="en">
    <head>
        <title>{% block title %}Social Network{% endblock %}</title>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
        <link href="{% static 'network/styles.css' %}" rel="stylesheet">

        <!-- Meta -->
        <meta charset="UTF-8">
	    <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- Font awesome -->
        <script src="https://kit.fontawesome.com/a122ebbd90.js" crossorigin="anonymous"></script>

        <!-- icon -->
        <link href="{% static 'network/media/network-icon.png' %}" rel="icon">

        <!-- Stylesheets -->
        <link href="{% static 'network/layout.css' %}" rel="stylesheet">
        <link href="{% static 'network/body.css' %}" rel="stylesheet">

        <!-- React Libraries -->
        <script src="https://unpkg.com/react@17/umd/react.production.min.js" crossorigin></script>
        <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js" crossorigin></script>
        <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
        
    </head>

    <body>

        <div class="blur" style="display: none;"></div>

        <!-- Detect the authentication of the user -->
        {% if user.is_authenticated %}
            <div id="authenticated" style="opacity: 0; width: 0; height: 0;">true</div>
        {% else %}
            <div id="authenticated" style="opacity: 0; width: 0; height: 0;">false</div>
        {% endif %}

        <div class="blur_wrapper"></div>

        <!-- Blur effect -->
        <script type="text/babel">
            
        </script>

        <!-- React layout -->
        <script type="text/babel">

            // Show page
            function Show(page){
                // Hide all pages 
                document.querySelectorAll('.page').forEach((el) => {
                    el.style.display = 'none';
                });

                // Show the clicked page
                document.querySelector(`#${page}`).style.display = 'flex';

                document.querySelectorAll('.item').forEach(function(el){
                    el.style.color = 'white';
                });

                // Focus on the clicked page
                document.querySelectorAll(`.${page}_item`).forEach(function(el) {
                    el.style.color = 'black';
                });
            }
            

            // Side bar
            function Sidebar(){
                window.onload = () => {
                    Show('allposts_page');
                    if (window.matchMedia("(max-width: 620px)").matches){
                        setOpen(false);
                    }
                }

                const auth = document.querySelector('#authenticated').innerHTML;
                function toBool(string){
                    if (string === 'true'){
                        return true;
                    }
                    else{
                        return false;
                    }
                }
                const[is_authenticated, setState] = React.useState(toBool(auth));
                const[open, setOpen] = React.useState(true);

                // Close sidebar
                function closeSidebar(){
                    if (open) {
                        setOpen(false);
                        document.querySelector('.blur').style.display = 'none';
                    }
                    else {
                        setOpen(true);
                        document.querySelector('button').style.animationDirection = "reverse";
                        document.querySelector('button').style.animationPlayState = "running";
                        if (window.matchMedia("(max-width: 600px)").matches) {
                            document.querySelector('.blur').style.display = 'block';
                        }
                    }
                }

                // Title
                function Title(){
                    // Opened sidebar
                    if (open){
                        return(
                            <div class="title_container">
                                <span className={open ? "show title_1": "hide title_1"}>N</span>
                                <span className={open ? "show title_2": "hide title_2"}>etwork</span>
                            </div>
                        );
                    }

                    // Closed sidebar
                    else{
                        return(
                            <div class="title_container">
                                <div className="logo-wrapper">
                                    <img src="/static/network/media/network-icon-white.png" alt="logo" className="logo"/>
                                </div>
                                <span className={open ? "show title_2": "hide title_2 shrink"}>etwork</span>
                            </div>
                        );
                    } 
                }
                // End of title
                
                // Main layout of sidebar
                return (
                    // Side bar
                    <div className={open ? "sidebar sidebaropen": "sidebar sidebarclose"}>

                        <div>
                            <div class="top-part">
                                
                                <Title />

                                <button onClick={closeSidebar} className={open ? "control-btn control-btn-open": "control-btn control-btn-close"}>
                                    <i className={open ? "fa-solid fa-arrow-up-short-wide close-icon": "fa-solid fa-arrow-up-short-wide open-icon"}></i>
                                </button>
                            </div>

                            <div class="navbar">
                                <a class="nav-item" href="#" onClick={() => Show('home_page')}>
                                    <i class="fa-solid fa-house home_page_item item"></i>
                                    <span className={open ? "show home_page_item item": "hide"}>Home</span>
                                </a>
                                <a class="nav-item" href="#" onClick={() => Show('allposts_page')}>
                                    <i class="fa-solid fa-envelopes-bulk allposts_page_item item"></i>
                                    <span className={open ? "show allposts_page_item item": "hide"}>All Posts</span>
                                </a>
                                
                                <a className={is_authenticated ? "nav-item": "delete"} href="#" onClick={() => Show('following_page')}>
                                    <i class="fa-brands fa-squarespace following_page_item item"></i>
                                    <span className={open ? "show following_page_item item": "hide"}>Following</span>
                                </a>
                                
                                <a class="nav-item" href="#" onClick={() => Show('profile_page')}>
                                    <i class="fa-solid fa-user profile_page_item item"></i>
                                    <span className={open ? "show profile_page_item item": "hide"} >Profile</span>
                                </a>
                            </div>
                        </div>

                        
                        <a className={is_authenticated ? "logout": "delete"} href="{% url 'logout' %}">
                            <i class="fa-solid fa-arrow-right-from-bracket" id="logout_icon"></i>
                            <span className={open ? "show": "hide"}>Logout</span>
                        </a>
                        
                        <div className={is_authenticated ? "delete": "wrapper"}>
                            <a class="register" href="{% url 'register' %}">
                                <i class="fa-regular fa-address-card"></i>
                                <span className={open ? "show": "hide"}>Register</span>
                            </a>
                            <a class="logout" href="{% url 'login' %}">
                                <i class="fa-solid fa-arrow-right-from-bracket" id="login_icon"></i>
                                <span className={open ? "show": "hide"}>Login</span>
                            </a>
                        </div>
                        
                    </div>
                );
            }

            // Add the components to the DOM
            ReactDOM.render(<Sidebar />, document.querySelector('#sidebar-container'));

        </script>

        <!-- Posts data -->
        <script data-posts="{{ posts }}" data-current_user="{{ current_user }}">
            // Getting required data
            const data = document.currentScript.dataset;
            var posts1 = data.posts;
            posts1 = JSON.parse(posts);

            current_user = data.current_user;
        </script>
    
        <!-- Home / All posts / Following / Profile -->
        <script type="text/babel">
            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = cookies[i].toString().replace(/^([\s]*)|([\s]*)$/g, "");
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            // All posts Page
            function Home(){
                // Return allposts conatiner
                return (
                    <div id="home_page" class="page">
                        <span>Home</span>
                    </div>
                );
            }

            // All posts Page
            function AllPosts(){
                // Checking if user is authenticated
                const auth = document.querySelector('#authenticated').innerHTML;
                function toBool(string){
                    if (string === 'true'){
                        return true;
                    }
                    else{
                        return false;
                    }
                }
                const[is_authenticated, setState] = React.useState(toBool(auth));

                // Get csrf token
                var csrftoken = getCookie('csrftoken');
                function Createpost(){
                    return (
                        <form className={is_authenticated ? "createpost_form" : "delete"} action="{% url 'create_post' %}" method="post">
                            <input type="hidden" name="csrfmiddlewaretoken" value={csrftoken} />
                            <div class="form_top">
                                <div>
                                    <i class="fa-solid fa-circle-user profile"></i>
                                    <textarea name="content" placeholder="Whatâ€™s happening"></textarea>
                                </div>
                            </div>
                            <div class="form_bottom">
                                <input type="submit" value="Post" />
                            </div>
                        </form>
                    );
                }

                // Post structure component
                function Post(props) {
                    // Editing state
                    const[editing, setEditing] = React.useState(false);

                    // Checking if the current user is the owner of the post
                    var is_owner = false;
                    if (props.username == current_user){
                        is_owner = true;
                    }

                    // Edit the content of a post
                    function edit(event){
                        let parent = event.target.parentNode.parentNode;
                        let content = parent.querySelector('.content');
                        if (editing === false){
                            setEditing(true);
                        }
                        else {
                            setEditing(false);
                        }
                    }
                    function edit_content(event){
                        const post = event.target.parentNode.parentNode.parentNode;
                        const new_content = post.querySelector('.edit_content').value;
                        console.log(new_content);
                    }

                    // Content Component
                    function Content(props){
                        if (editing === false){
                            return(
                                <span class="content">{ props.content }</span>
                            );
                        }
                        else {
                            return(
                                <textarea class="content edit_content">{ props.content }</textarea>
                            );
                        }
                    }
                    // Edit Component
                    function Edit(){
                        if (editing === false){
                            return (
                                <a className={is_owner ? "edit": "delete"} onClick={() => edit(event)}>Edit</a>
                            );
                        }
                        else {
                            return (
                                <div class="done_wrapper">
                                    <button className="done btn btn-primary" onClick={() => {edit_content(event); edit(event);}}>Done</button>
                                </div>
                            );
                        }
                    }

                    // Render the post 
                    return (
                        <div class="post">
                            <div class="post_header">
                                <div>
                                    <i class="fa-solid fa-circle-user profile"></i>
                                    <a class="username">{ props.username }</a>
                                    <span class="date">{ props.created_on }</span>
                                </div>
                                <Edit />
                            </div>
                            <Content content={ props.content } />
                            <div class="likes">
                                <i class="fa-solid fa-heart"></i>
                                <span>{ props.likes }</span>
                            </div>
                        </div>
                    );
                }
                
                // Getting all posts and displaying them to the user
                function Posts(){ 
                    const[posts, setPosts] = React.useState(null);
                    var posts_array = [];

                    // Fetch posts
                    fetch('/posts')
                    .then(response => response.json())
                    .then(data => {
                        // Loop over each post
                        for(let i = 0; i < data.length; i++){
                            var post = JSON.parse(data[i]);
                            posts_array.push(<Post key={i} username={post.author}  created_on={post.created_on} content={post.content} likes={post.likes} />);
                        }
                        setPosts(posts_array);
                        console.log(posts_array);
                    })
                    .catch(error => {
                        console.log(error);
                    });
                    
                    
                    return <div class="posts_wrapper">{posts}</div>;
                }

                // Return allposts conatiner
                return (
                    <div id="allposts_page" class="page">
                        <div class="header">
                            <span>All Posts</span>
                            <img src="{% static 'network/media/stars.png' %}" />
                        </div>
                        
                        <Createpost />
                        <Posts />
                    </div>
                );
            }
            // End of all posts page

            // All posts Page
            function Following(){
                // Return allposts conatiner
                return (
                    <div id="following_page" class="page">
                        <span>Following</span>
                    </div>
                );
            }

            // Profile Page
            function Profile(){
                // Return Profile conatiner
                return (
                    <div id="profile_page" class="page">
                        <span>Profile</span>
                    </div>
                );
            }
            
            // Render All Posts page to the DOM
            ReactDOM.render(<div class="page_wrapper"><Home /> <AllPosts /> <Following /> <Profile /></div>, document.querySelector('.body'));
        
        </script>


        <!-- Sidebar -->
        <div id="sidebar-container"></div>

        <!-- Body -->
        <div class="body"></div>

    </body>

</html>